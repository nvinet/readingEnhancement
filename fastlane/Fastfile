# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out:
# https://docs.fastlane.tools/actions

# Load environment variables from .env file if it exists
if File.exist?('../fastlane/.env')
  require 'dotenv'
  Dotenv.load('../fastlane/.env')
end

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Ensure we're on a clean git state (optional, can be removed if you want to deploy with uncommitted changes)
    # ensure_git_status_clean
    
    # Increment build number (optional - use if you want automatic build number bumping)
    increment_build_number(xcodeproj: "ios/readingEnhancement.xcodeproj")
    
    # Install CocoaPods dependencies
    cocoapods(podfile: "ios/Podfile")
    
    # Build the iOS app
    build_app(
      workspace: "ios/readingEnhancement.xcworkspace",
      scheme: "readingEnhancement",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.nvinet.readingEnhancement" => "match AppStore com.nvinet.readingEnhancement" # Update with your provisioning profile name
        }
      }
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true, # Set to false if you want to wait for Apple to process the build
      skip_submission: false, # Set to true if you want to manually submit to testers
      distribute_external: false, # Set to true if you want to distribute to external testers immediately
      notify_external_testers: false
    )
    
    # Optional: Commit version bump
    # commit_version_bump(
    #   message: "Version Bump by fastlane",
    #   xcodeproj: "ios/readingEnhancement.xcodeproj"
    # )
    
    # Optional: Add a git tag
    # add_git_tag
    
    # Optional: Push to remote
    # push_to_git_remote
  end
  
  desc "Deploy a new version to TestFlight (alias for beta)"
  lane :deploy do
    beta
  end
end
